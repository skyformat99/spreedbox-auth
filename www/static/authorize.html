<!doctype html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script src="./lib/sha.js"></script>
<script src="./scripts/spreedbox-auth.js"></script>
<script>
(function(root, auth) {
	"use strict";

	var query = auth.decodeParams(location.search.substring(1));
	function handler(params) {
		if (!query.target) {
			return;
		}
		var link = document.createElement('a');
		link.href = query.target;
		link.hash = auth.encodeParams(params);
		if (link.protocol !== 'https:' || link.host !== location.host) {
			throw 'invalid or insecure target';
		}
		var url = link.protocol + '//' + link.host + link.pathname + link.search + link.hash;

		location.replace(url);
	}
	// Authorize and redirect.
	auth.authorize({
		onSuccess: function(values) {
			var params = {};
			for (var key in values) {
				if (values.hasOwnProperty(key)) {
					switch (key) {
					case 'access_token_raw':
					case 'id_token_raw':
						params[key.substr(0, key.length - 4)] = values[key];
						break;
					case 'code':
					case 'token_type':
					case 'expires_in':
					case 'state':
						params[key] = values[key];
					default:
						break;
					}
				}
			}
			handler(params);
		},
		onError: function(error) {
			var params = {
				error: error.error || 'unknown error',
				error_description: error.error_description || ''
			};
			handler(params);
		}
	});
}(this, this.spreedboxAuth));
</script>
</head>
<body></body>
</html>